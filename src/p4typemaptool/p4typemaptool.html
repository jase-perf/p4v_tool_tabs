<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>P4 Typemap Editor</title>
    <script type="text/javascript">
      var darktheme = p4vjs.useDarkTheme();
      if (darktheme) {
        document.write(
          '<link rel="stylesheet" type="text/css" href="../darkstyle.css" />'
        );
      } else {
        document.write(
          '<link rel="stylesheet" type="text/css" href="../style.css" />'
        );
      }
    </script>
    <style>
      /* Theme-compatible styles - use CSS variables that work with both themes */
      .typemap-container {
        padding: 10px;
      }

      .toolbar {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .view-mode-toggle {
        display: flex;
        gap: 5px;
      }

      .test-section {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .test-input {
        width: 300px;
      }

      .test-result {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 3px;
      }

      .test-result.match {
        background: #d4edda;
        color: #155724;
      }

      .test-result.no-match {
        background: #f8d7da;
        color: #721c24;
      }

      /* Enhanced table with resizable columns and sortable headers */
      .typemap-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        table-layout: fixed;
      }

      .typemap-table th {
        position: relative;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        padding-right: 20px;
      }

      .typemap-table th:hover {
        opacity: 0.8;
      }

      .typemap-table th.sortable::after {
        content: " ↕";
        position: absolute;
        right: 5px;
        opacity: 0.5;
      }

      .typemap-table th.sort-asc::after {
        content: " ↑";
        opacity: 1;
      }

      .typemap-table th.sort-desc::after {
        content: " ↓";
        opacity: 1;
      }

      /* Column resizer */
      .column-resizer {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
      }

      .column-resizer:hover {
        background: rgba(0, 123, 204, 0.3);
      }

      .priority-cell {
        width: 120px;
        text-align: center;
      }

      .execution-order-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }

      .order-button {
        width: 20px;
        height: 20px;
        padding: 0;
        margin: 0;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        border-radius: 2px;
      }

      .order-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .file-type-cell {
        min-width: 200px;
      }

      .file-type-display {
        cursor: pointer;
        padding: 5px;
        border-radius: 3px;
      }

      .type-label {
        display: block;
        font-weight: bold;
      }

      .type-code {
        display: block;
        font-size: 0.9em;
        font-family: monospace;
        opacity: 0.7;
      }

      .file-type-editor {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .editor-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .modifier-category {
        margin-bottom: 15px;
      }

      .modifier-category h4 {
        margin: 0 0 8px 0;
        font-size: 0.9em;
      }

      .modifier-category label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        cursor: pointer;
      }

      .modifier-category input[type="checkbox"] {
        margin-right: 8px;
      }

      .result-preview {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        opacity: 0.9;
      }

      .pattern-input,
      .comment-input {
        width: 100%;
        resize: none;
      }

      .actions-cell {
        width: 120px;
        text-align: center;
      }

      .conflict-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 5px;
        border-radius: 3px;
        font-size: 0.9em;
        color: #856404;
      }

      .validation-warning {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 5px;
        border-radius: 3px;
        font-size: 0.9em;
        color: #721c24;
        margin-top: 5px;
      }

      .help-text {
        font-size: 0.9em;
        font-style: italic;
        margin-top: 5px;
        opacity: 0.7;
      }

      .loading {
        text-align: center;
        padding: 40px;
        opacity: 0.7;
      }

      /* Dark theme specific overrides */
      body.dark-theme .test-result.match {
        background: #1e4620;
        color: #90ee90;
      }

      body.dark-theme .test-result.no-match {
        background: #4a1e1e;
        color: #ffb3b3;
      }

      body.dark-theme .conflict-warning {
        background: #4a4a1e;
        border-color: #6a6a2e;
        color: #ffff99;
      }

      body.dark-theme .validation-warning {
        background: #4a1e1e;
        border-color: #6a2e2e;
        color: #ffb3b3;
      }
    </style>
    <script type="text/javascript" src="p4typemaptool.js"></script>
  </head>
  <body onload="initializeTypemapEditor()">
    <div class="typemap-container">
      <header>
        <h2>P4 Typemap Editor</h2>
        <p>
          Configure file type mappings for your Perforce server. Rules are
          evaluated in order - later rules override earlier ones.
        </p>
      </header>

      <div class="toolbar">
        <div class="view-mode-toggle">
          <button
            id="browseMode"
            class="active"
            onclick="setViewMode('browse')"
          >
            Browse Mode
          </button>
          <button id="orderMode" onclick="setViewMode('order')">
            Execution Order
          </button>
        </div>

        <label for="sortBy">Sort by:</label>
        <select id="sortBy" onchange="sortTable()">
          <option value="order">Execution Order</option>
          <option value="pattern">Depot Path</option>
          <option value="type">File Type</option>
        </select>

        <div class="test-section">
          <label for="testPath">Test Path:</label>
          <input
            type="text"
            id="testPath"
            class="test-input"
            placeholder="//depot/example/test.pdf"
            onchange="testPath()"
          />
          <button onclick="testPath()" class="btn">Test</button>
          <span id="testResult" class="test-result"></span>
        </div>

        <button onclick="addNewRule()" class="btn primary">Add Rule</button>
        <button onclick="saveTypemap()" class="btn primary">Save</button>
        <button onclick="loadTypemap()" class="btn">Reload</button>
      </div>

      <div id="loadingIndicator" class="loading">Loading typemap...</div>

      <table id="typemapTable" class="typemap-table" style="display: none">
        <thead>
          <tr>
            <th class="priority-cell">
              Execution Order
              <div
                class="column-resizer"
                onmousedown="startColumnResize(event, 0)"
              ></div>
            </th>
            <th class="sortable" onclick="sortByColumn('type')">
              File Type
              <div
                class="column-resizer"
                onmousedown="startColumnResize(event, 1)"
              ></div>
            </th>
            <th class="sortable" onclick="sortByColumn('pattern')">
              Depot Path Pattern
              <div
                class="column-resizer"
                onmousedown="startColumnResize(event, 2)"
              ></div>
            </th>
            <th class="sortable" onclick="sortByColumn('comment')">
              Comment
              <div
                class="column-resizer"
                onmousedown="startColumnResize(event, 3)"
              ></div>
            </th>
            <th class="actions-cell">Actions</th>
          </tr>
        </thead>
        <tbody id="typemapTableBody">
          <!-- Rules will be populated here -->
        </tbody>
      </table>

      <div class="status-bar">
        <span id="statusMessage">Ready</span>
        <span id="ruleCount" style="float: right"></span>
      </div>
    </div>

    <!-- Hidden template for file type editor -->
    <div id="fileTypeEditorTemplate" style="display: none">
      <div class="file-type-editor">
        <div style="margin-bottom: 15px">
          <label for="baseFileType">Base File Type:</label>
          <select
            id="baseFileType"
            style="width: 100%; padding: 5px"
            onchange="updateFileTypePreview()"
          >
            <option value="binary">
              Binary - Binary file (images, executables, etc.)
            </option>
            <option value="text">Text - Text file</option>
            <option value="symlink">
              Symbolic Link - Unix/Mac symbolic link
            </option>
            <option value="unicode">Unicode - Unicode text file</option>
            <option value="utf8">UTF-8 - Unicode file with BOM</option>
            <option value="utf16">UTF-16 - Unicode file</option>
          </select>
          <div class="help-text" id="fileTypeHelp"></div>
        </div>

        <div class="modifier-category">
          <h4>Permissions & Access</h4>
          <label
            ><input
              type="checkbox"
              value="w"
              onchange="updateFileTypePreview()"
            />
            Always Writable (+w) - File is always writable on client</label
          >
          <label
            ><input
              type="checkbox"
              value="x"
              onchange="updateFileTypePreview()"
            />
            Executable (+x) - Execute bit set on client</label
          >
          <label
            ><input
              type="checkbox"
              value="l"
              onchange="updateFileTypePreview()"
            />
            Exclusive Lock (+l) - Only one user can edit at a time</label
          >
        </div>

        <div class="modifier-category">
          <h4>Keyword Expansion</h4>
          <label
            ><input
              type="checkbox"
              value="k"
              onchange="updateFileTypePreview()"
            />
            RCS Keywords (+k) - Expands $Id$, $Date$, $Author$, etc.</label
          >
          <label
            ><input
              type="checkbox"
              value="ko"
              onchange="updateFileTypePreview()"
            />
            Limited Keywords (+ko) - Only expands $Id$ and $Header$</label
          >
        </div>

        <div class="modifier-category">
          <h4>Storage Options</h4>
          <label
            ><input
              type="checkbox"
              value="C"
              onchange="updateFileTypePreview()"
            />
            Compressed Storage (+C) - Full compressed version per
            revision</label
          >
          <label
            ><input
              type="checkbox"
              value="D"
              onchange="updateFileTypePreview()"
            />
            Delta Storage (+D) - Store deltas in RCS format</label
          >
          <label
            ><input
              type="checkbox"
              value="F"
              onchange="updateFileTypePreview()"
            />
            Full Uncompressed (+F) - Full file per revision, uncompressed</label
          >
          <label
            ><input
              type="checkbox"
              value="S"
              onchange="updateFileTypePreview()"
            />
            Head Only (+S) - Only store latest revision</label
          >
          <label
            ><input
              type="checkbox"
              value="S10"
              onchange="updateFileTypePreview()"
            />
            Keep 10 Revisions (+S10) - Store most recent 10 revisions</label
          >
        </div>

        <div class="modifier-category">
          <h4>Special Options</h4>
          <label
            ><input
              type="checkbox"
              value="m"
              onchange="updateFileTypePreview()"
            />
            Preserve Modtime (+m) - Keep original file modification time</label
          >
          <label
            ><input
              type="checkbox"
              value="X"
              onchange="updateFileTypePreview()"
            />
            Archive Trigger (+X) - Requires archive trigger to access</label
          >
        </div>

        <div class="result-preview">
          <strong>Resulting File Type:</strong>
          <code id="resultingType">binary</code>
        </div>

        <div id="validationWarnings"></div>

        <div style="margin-top: 15px; text-align: right">
          <button onclick="cancelFileTypeEdit()" class="btn">Cancel</button>
          <button onclick="applyFileTypeEdit()" class="btn primary">
            Apply
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
